<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Finder - AROGYA Healthcare</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Custom Styles -->
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        #map {
            height: 600px;
            border-radius: 0.5rem;
        }
        .hospital-marker {
            transition: all 0.3s ease;
        }
        .hospital-marker:hover {
            transform: scale(1.05);
        }
        .sidebar-hospital {
            transition: all 0.3s ease;
        }
        .sidebar-hospital:hover {
            background-color: #f3f4f6;
            transform: translateX(4px);
        }
        .active-hospital {
            background-color: #ede9fe;
            border-left: 4px solid #7c3aed;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-purple-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold text-lg">A</span>
                        </div>
                        <span class="font-bold text-xl text-gray-800">AROGYA</span>
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-gray-700 hover:text-purple-700 px-3 py-2 rounded-md text-sm font-medium">Home</a>
                    <a href="/dashboard" class="text-gray-700 hover:text-purple-700 px-3 py-2 rounded-md text-sm font-medium">Dashboard</a>
                    <a href="/symptom-checker" class="text-gray-700 hover:text-purple-700 px-3 py-2 rounded-md text-sm font-medium">Symptom Checker</a>
                    <a href="/hospital-finder" class="text-purple-700 px-3 py-2 rounded-md text-sm font-medium bg-purple-50">Hospital Finder</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <div class="gradient-bg text-white py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <h1 class="text-3xl font-bold mb-2">Hospital Finder</h1>
                <p class="text-purple-100">Find hospitals near you or search by location</p>
            </div>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="bg-white shadow-md sticky top-16 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Search Box -->
                <div class="md:col-span-2">
                    <div class="relative">
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="Search by location (Delhi, Bengaluru, Kengeri...)"
                            class="w-full px-4 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        >
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <!-- Location Suggestions -->
                    <div id="locationSuggestions" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg hidden">
                    </div>
                </div>

                <!-- Category Filter -->
                <div>
                    <select id="categoryFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">All Categories</option>
                        <option value="emergency">Emergency</option>
                        <option value="government">Government</option>
                        <option value="private">Private</option>
                        <option value="clinic">Clinic</option>
                        <option value="multi-speciality">Multi-speciality</option>
                    </select>
                </div>

                <!-- Action Buttons -->
                <div class="flex space-x-2">
                    <button 
                        id="searchBtn"
                        class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition font-medium"
                    >
                        Search
                    </button>
                    <button 
                        id="locationBtn"
                        class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition font-medium"
                    >
                        üìç Use Current Location
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Map -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-gray-800">Hospital Map</h2>
                        <div class="flex items-center space-x-2">
                            <div class="flex items-center space-x-1">
                                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                <span class="text-xs text-gray-600">Emergency</span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                                <span class="text-xs text-gray-600">Government</span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                <span class="text-xs text-gray-600">Private</span>
                            </div>
                        </div>
                    </div>
                    <div id="map"></div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-gray-800">Hospitals</h2>
                        <span id="hospitalCount" class="text-sm text-gray-600">0 hospitals</span>
                    </div>
                    
                    <!-- Loading State -->
                    <div id="loadingState" class="text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                        <p class="mt-4 text-gray-600">Searching hospitals...</p>
                    </div>

                    <!-- Hospital List -->
                    <div id="hospitalList" class="space-y-4 max-h-96 overflow-y-auto hidden">
                    </div>

                    <!-- No Results -->
                    <div id="noResults" class="text-center py-8 hidden">
                        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        <p class="text-gray-600">No hospitals found</p>
                        <p class="text-sm text-gray-500 mt-2">Try adjusting your search criteria</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Global variables
        let map;
        let markers = [];
        let hospitals = [];
        let currentLocation = null;

        // Initialize map
        function initMap() {
            map = L.map('map').setView([20.5937, 78.9629], 5); // Center on India
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }

        // Get marker color based on hospital category
        function getMarkerColor(hospital) {
            const category = hospital.category.toLowerCase();
            const careType = hospital.care_type.toLowerCase();
            
            if (category.includes('government') || careType.includes('public')) {
                return '#3B82F6'; // Blue
            } else if (category.includes('private') || careType.includes('private')) {
                return '#10B981'; // Green
            } else if (category.includes('emergency') || hospital.emergency) {
                return '#EF4444'; // Red
            } else {
                return '#6B7280'; // Gray
            }
        }

        // Add hospital markers to map
        function addHospitalMarkers(hospitalData) {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            hospitalData.forEach(hospital => {
                if (hospital.latitude === 0 || hospital.longitude === 0) return;

                const color = getMarkerColor(hospital);
                
                const marker = L.circleMarker([hospital.latitude, hospital.longitude], {
                    radius: 8,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                // Popup content
                const popupContent = `
                    <div class="p-2">
                        <h3 class="font-bold text-sm">${hospital.name}</h3>
                        <p class="text-xs text-gray-600">${hospital.address}</p>
                        <p class="text-xs text-gray-600">${hospital.district}, ${hospital.state}</p>
                        ${hospital.telephone && hospital.telephone !== '0' ? `<p class="text-xs">üìû ${hospital.telephone}</p>` : ''}
                        ${hospital.emergency && hospital.emergency !== '0' ? `<p class="text-xs text-red-600">üö® Emergency: ${hospital.emergency}</p>` : ''}
                    </div>
                `;

                marker.bindPopup(popupContent);
                
                // Click event
                marker.on('click', () => {
                    highlightHospital(hospital.id);
                });

                markers.push(marker);
            });

            // Fit map to markers
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Render hospital list in sidebar
        function renderHospitalList(hospitalData) {
            const listContainer = document.getElementById('hospitalList');
            const countElement = document.getElementById('hospitalCount');
            
            countElement.textContent = `${hospitalData.length} hospital${hospitalData.length !== 1 ? 's' : ''}`;

            listContainer.innerHTML = hospitalData.map(hospital => `
                <div id="hospital-${hospital.id}" class="sidebar-hospital p-4 border border-gray-200 rounded-lg cursor-pointer" onclick="highlightHospital('${hospital.id}')">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-gray-800">${hospital.name}</h3>
                        <span class="text-xs px-2 py-1 bg-purple-100 text-purple-800 rounded">${hospital.category || 'General'}</span>
                    </div>
                    
                    <div class="text-sm text-gray-600 mb-2">
                        <p class="flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            ${hospital.address}
                        </p>
                        <p class="ml-5">${hospital.district}, ${hospital.state} - ${hospital.pincode}</p>
                        ${hospital.distance_km ? `<p class="ml-5 text-purple-600">üìç ${hospital.distance_km.toFixed(1)} km away</p>` : ''}
                    </div>
                    
                    <div class="flex flex-wrap gap-2">
                        ${hospital.telephone && hospital.telephone !== '0' ? `
                            <button onclick="event.stopPropagation(); callHospital('${hospital.telephone}')" class="flex items-center space-x-1 text-xs bg-green-100 text-green-800 px-2 py-1 rounded hover:bg-green-200">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                </svg>
                                <span>Call</span>
                            </button>
                        ` : ''}
                        
                        <button onclick="event.stopPropagation(); getDirections(${hospital.latitude}, ${hospital.longitude})" class="flex items-center space-x-1 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded hover:bg-blue-200">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                            </svg>
                            <span>Directions</span>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Highlight hospital in sidebar
        function highlightHospital(hospitalId) {
            // Remove previous highlights
            document.querySelectorAll('.sidebar-hospital').forEach(el => {
                el.classList.remove('active-hospital');
            });

            // Add highlight to selected hospital
            const hospitalElement = document.getElementById(`hospital-${hospitalId}`);
            if (hospitalElement) {
                hospitalElement.classList.add('active-hospital');
                hospitalElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            // Open marker popup
            const hospital = hospitals.find(h => h.id === hospitalId);
            if (hospital) {
                markers.forEach(marker => {
                    const position = marker.getLatLng();
                    if (Math.abs(position.lat - hospital.latitude) < 0.0001 && 
                        Math.abs(position.lng - hospital.longitude) < 0.0001) {
                        marker.openPopup();
                    }
                });
            }
        }

        // Call hospital
        function callHospital(phone) {
            window.open(`tel:${phone}`);
        }

        // Get directions
        function getDirections(lat, lon) {
            if (currentLocation) {
                window.open(`https://www.google.com/maps/dir/${currentLocation.lat},${currentLocation.lon}/${lat},${lon}`);
            } else {
                window.open(`https://www.google.com/maps/search/?api=1&query=${lat},${lon}`);
            }
        }

        // Search hospitals
        async function searchHospitals() {
            const searchQuery = document.getElementById('searchInput').value;
            const category = document.getElementById('categoryFilter').value;
            
            showLoading(true);

            try {
                let url = 'http://localhost:5000/hospital/search';
                const params = new URLSearchParams();

                if (searchQuery) {
                    params.append('q', searchQuery);
                }
                if (currentLocation) {
                    params.append('lat', currentLocation.lat);
                    params.append('lon', currentLocation.lon);
                    params.append('radius_km', '10');
                }
                if (category) {
                    params.append('category', category);
                }

                if (params.toString()) {
                    url += '?' + params.toString();
                }

                const response = await fetch(url);
                const data = await response.json();

                hospitals = data.hospitals || [];
                renderHospitalList(hospitals);
                addHospitalMarkers(hospitals);
                
                showLoading(false);
                showNoResults(hospitals.length === 0);

            } catch (error) {
                console.error('Search error:', error);
                showLoading(false);
                showNoResults(true);
            }
        }

        // Get current location
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        
                        // Add current location marker
                        L.marker([currentLocation.lat, currentLocation.lon])
                            .addTo(map)
                            .bindPopup('Your Location')
                            .openPopup();
                        
                        map.setView([currentLocation.lat, currentLocation.lon], 12);
                        
                        // Search nearby hospitals
                        searchHospitals();
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        alert('Unable to get your location. Please enable location services.');
                    }
                );
            } else {
                alert('Geolocation is not supported by your browser.');
            }
        }

        // Load location suggestions
        async function loadLocationSuggestions(query) {
            if (query.length < 2) {
                hideSuggestions();
                return;
            }

            try {
                const response = await fetch(`http://localhost:5000/hospital/locations?q=${encodeURIComponent(query)}`);
                const locations = await response.json();
                
                showSuggestions(locations);
            } catch (error) {
                console.error('Error loading suggestions:', error);
            }
        }

        // Show/hide suggestions
        function showSuggestions(locations) {
            const container = document.getElementById('locationSuggestions');
            
            if (locations.length === 0) {
                hideSuggestions();
                return;
            }

            container.innerHTML = locations.map(loc => `
                <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectLocation('${loc.name}', ${loc.latitude}, ${loc.longitude})">
                    <div class="font-medium">${loc.name}</div>
                    <div class="text-sm text-gray-600">${loc.district}, ${loc.state}</div>
                </div>
            `).join('');

            container.classList.remove('hidden');
        }

        function hideSuggestions() {
            document.getElementById('locationSuggestions').classList.add('hidden');
        }

        function selectLocation(name, lat, lon) {
            document.getElementById('searchInput').value = name;
            hideSuggestions();
            
            // Center map on location
            map.setView([lat, lon], 12);
            
            // Search hospitals
            searchHospitals();
        }

        // Loading states
        function showLoading(show) {
            document.getElementById('loadingState').classList.toggle('hidden', !show);
            document.getElementById('hospitalList').classList.toggle('hidden', show);
            document.getElementById('noResults').classList.toggle('hidden', true);
        }

        function showNoResults(show) {
            document.getElementById('noResults').classList.toggle('hidden', !show);
            document.getElementById('hospitalList').classList.toggle('hidden', show);
            document.getElementById('loadingState').classList.add('hidden');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            
            // Search button
            document.getElementById('searchBtn').addEventListener('click', searchHospitals);
            
            // Current location button
            document.getElementById('locationBtn').addEventListener('click', getCurrentLocation);
            
            // Search input
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    loadLocationSuggestions(this.value);
                }, 300);
            });
            
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    hideSuggestions();
                    searchHospitals();
                }
            });
            
            // Category filter
            document.getElementById('categoryFilter').addEventListener('change', searchHospitals);
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#searchInput') && !e.target.closest('#locationSuggestions')) {
                    hideSuggestions();
                }
            });
            
            // Load initial hospitals
            searchHospitals();
        });
    </script>
</body>
</html>
