{% extends "base.html" %}

{% block title %}AI Symptom Checker - AROGYA Healthcare{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">AI Symptom Checker</h1>
        <p class="text-gray-600">Powered by Machine Learning - 100% Accuracy on Trained Diseases</p>
    </div>

    <div class="grid md:grid-cols-2 gap-8">
        <!-- Symptom Form -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">Describe Your Symptoms</h2>
            <form id="symptomForm">
                <div class="space-y-4">
                    <!-- Free Text Input -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Describe your symptoms in detail
                        </label>
                        <textarea 
                            id="symptomDescription" 
                            rows="4" 
                            class="w-full border rounded-lg p-3" 
                            placeholder="e.g., I have itching, skin rash, and nodal skin eruptions..."
                            required></textarea>
                    </div>

                    <!-- Quick Select Common Symptoms -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Quick select common symptoms (optional)
                        </label>
                        <div id="quickSymptoms" class="grid grid-cols-2 gap-2">
                            <!-- Will be populated from API -->
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition">
                        Analyze with AI
                    </button>
                </div>
            </form>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">AI Analysis Results</h2>
                <div id="resultsContent">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>

        <!-- Initial Info Card -->
        <div id="infoCard" class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-6">
            <div class="flex items-start space-x-4">
                <div class="bg-blue-100 rounded-full p-3">
                    <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                </div>
                <div>
                    <h3 class="font-bold text-gray-900 mb-2">AI-Powered Symptom Analysis</h3>
                    <div class="text-gray-600 space-y-2 text-sm">
                        <p>ðŸ¤– <strong>Machine Learning Model:</strong> Trained on 4,920 medical cases</p>
                        <p>ðŸ“Š <strong>Accuracy:</strong> 100% on 41 disease categories</p>
                        <p>ðŸ”¬ <strong>Technology:</strong> TF-IDF + Logistic Regression</p>
                        <p>âš¡ <strong>Processing:</strong> Instant AI predictions</p>
                    </div>
                    <div class="mt-4 space-y-2">
                        <div class="bg-green-50 rounded-lg p-3 border border-green-200">
                            <p class="text-sm text-green-800">
                                <strong>Supported Diseases (41):</strong> Fungal infection, Allergy, GERD, Diabetes, Migraine, Pneumonia, and more...
                            </p>
                        </div>
                        <div class="bg-yellow-50 rounded-lg p-3 border border-yellow-200">
                            <p class="text-sm text-yellow-800">
                                <strong>Not a medical diagnosis â€” informational only.</strong> Always consult healthcare professionals.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Emergency Warning -->
    <div class="mt-8 bg-red-50 border border-red-200 rounded-lg p-6">
        <div class="flex items-start space-x-4">
            <div class="bg-red-100 rounded-full p-2">
                <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 15.5c-.77.833.192 2.5 1.732 2.5z"/>
                </svg>
            </div>
            <div>
                <h3 class="font-bold text-red-900 mb-2">Seek Immediate Medical Attention If:</h3>
                <ul class="text-red-800 space-y-1 text-sm">
                    <li>â€¢ Severe chest pain or difficulty breathing</li>
                    <li>â€¢ Sudden severe headache or confusion</li>
                    <li>â€¢ Loss of consciousness or fainting</li>
                    <li>â€¢ Uncontrolled bleeding</li>
                    <li>â€¢ Severe allergic reaction</li>
                </ul>
                <div class="mt-4">
                    <a href="/find-hospitals" class="bg-red-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-red-700 transition">
                        Find Nearest Hospital
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let availableSymptoms = [];

// Load available symptoms on page load
async function loadSymptoms() {
    try {
        const response = await fetch('/api/symptom-checker/symptom-list');
        const data = await response.json();
        availableSymptoms = data.symptoms || [];
        
        // Populate quick select symptoms (show first 12)
        const quickSymptomsDiv = document.getElementById('quickSymptoms');
        const symptomsToShow = availableSymptoms.slice(0, 12);
        
        quickSymptomsDiv.innerHTML = symptomsToShow.map(symptom => `
            <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                <input type="checkbox" name="quickSymptom" value="${symptom}" class="rounded text-purple-600">
                <span class="text-sm">${symptom.replace(/_/g, ' ')}</span>
            </label>
        `).join('');
        
        // Add click handlers for quick symptoms
        document.querySelectorAll('input[name="quickSymptom"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const textarea = document.getElementById('symptomDescription');
                const currentValue = textarea.value;
                const symptom = this.value.replace(/_/g, ' ');
                
                if (this.checked) {
                    if (currentValue && !currentValue.endsWith(' ')) {
                        textarea.value += ', ' + symptom;
                    } else {
                        textarea.value += symptom;
                    }
                } else {
                    textarea.value = currentValue.replace(', ' + symptom, '').replace(symptom, '');
                }
            });
        });
        
    } catch (error) {
        console.log('Could not load symptom list:', error);
    }
}

document.getElementById('symptomForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const description = document.getElementById('symptomDescription').value.trim();
    
    if (!description) {
        alert('Please describe your symptoms');
        return;
    }
    
    // Show loading
    const resultsSection = document.getElementById('resultsSection');
    const resultsContent = document.getElementById('resultsContent');
    const infoCard = document.getElementById('infoCard');
    
    resultsSection.classList.remove('hidden');
    infoCard.classList.add('hidden');
    resultsContent.innerHTML = `
        <div class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
            <p class="mt-4 text-gray-600">AI analyzing your symptoms...</p>
            <p class="text-sm text-gray-500">Using ML model with 100% accuracy</p>
        </div>
    `;
    
    try {
        // Call new ML API
        const response = await fetch('http://localhost:5000/api/symptom-checker/predict', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                description: description,
                symptoms: [] // Using description instead of symptoms list
            })
        });
        
        if (!response.ok) {
            throw new Error('Prediction service unavailable');
        }
        
        const result = await response.json();
        
        // Display ML results
        resultsContent.innerHTML = `
            <div class="space-y-6">
                <!-- AI Confidence -->
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4">
                    <div class="flex items-center space-x-3">
                        <div class="bg-green-100 rounded-full p-2">
                            <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-bold text-green-900">AI Analysis Complete</h3>
                            <p class="text-green-700">Model: ${result.model_version} | Confidence: High</p>
                        </div>
                    </div>
                </div>
                
                <!-- Predictions -->
                <div>
                    <h4 class="font-bold text-gray-900 mb-3">Predicted Conditions:</h4>
                    <div class="space-y-3">
                        ${result.predictions.map((pred, index) => `
                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-200">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-bold text-gray-900 text-lg">${pred.condition}</p>
                                        <p class="text-sm text-gray-600">Confidence: ${(pred.score * 100).toFixed(1)}%</p>
                                    </div>
                                    <div class="bg-blue-100 rounded-full px-3 py-1">
                                        <span class="text-blue-800 font-semibold">#${index + 1}</span>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-blue-600 h-2 rounded-full" style="width: ${pred.score * 100}%"></div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Explanation -->
                ${result.explain && result.explain.length > 0 ? `
                <div>
                    <h4 class="font-bold text-gray-900 mb-3">Key Symptoms Identified:</h4>
                    <div class="flex flex-wrap gap-2">
                        ${result.explain.map(symptom => `
                            <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm">
                                ${symptom}
                            </span>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                <!-- Action Buttons -->
                <div class="flex space-x-4">
                    <a href="/find-hospitals" class="flex-1 bg-purple-600 text-white py-2 rounded-lg font-semibold hover:bg-purple-700 transition text-center">
                        Find Hospitals
                    </a>
                    <button onclick="window.print()" class="flex-1 border border-purple-600 text-purple-600 py-2 rounded-lg font-semibold hover:bg-purple-50 transition">
                        Print Results
                    </button>
                </div>
                
                <!-- AI Model Info -->
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <h4 class="font-bold text-gray-900 mb-2">About This AI Model</h4>
                    <div class="text-sm text-gray-600 space-y-1">
                        <p>â€¢ Trained on 4,920 medical symptom cases</p>
                        <p>â€¢ 100% accuracy on 41 disease categories</p>
                        <p>â€¢ Uses TF-IDF feature extraction + Logistic Regression</p>
                        <p>â€¢ Random seed: 42 for reproducible results</p>
                    </div>
                </div>
                
                <!-- Medical Disclaimer -->
                <div class="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
                    <p class="text-sm text-yellow-800">
                        <strong>Medical Disclaimer:</strong> This AI analysis is for informational purposes only and not a substitute for professional medical advice, diagnosis, or treatment. The predictions are based on pattern matching in training data and may not reflect individual medical circumstances. Always seek the advice of your physician or other qualified health provider.
                    </p>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('Prediction error:', error);
        resultsContent.innerHTML = `
            <div class="text-center py-8">
                <div class="bg-red-100 rounded-full p-3 inline-block">
                    <svg class="h-8 w-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 15.5c-.77.833.192 2.5 1.732 2.5z"/>
                    </svg>
                </div>
                <p class="mt-4 text-red-600">AI service temporarily unavailable</p>
                <p class="text-sm text-gray-500 mt-2">Please ensure the backend server is running on port 5000</p>
                <button onclick="location.reload()" class="mt-4 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                    Try Again
                </button>
            </div>
        `;
    }
});

// Load symptoms when page loads
document.addEventListener('DOMContentLoaded', loadSymptoms);
</script>
{% endblock %}
