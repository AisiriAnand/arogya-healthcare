<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medication Reminders - AROGYA Healthcare</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-900">Medication Reminders</h1>
        <p class="text-gray-600">Never miss your medications with smart reminders</p>
        
        <div class="bg-white rounded-lg shadow-lg p-6 mt-8">
            <h2 class="text-xl font-bold mb-4">Add New Reminder</h2>
            <form id="reminderForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Medication Name</label>
                        <input type="text" name="medication" required class="w-full border rounded-lg p-2" placeholder="e.g., Aspirin">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Dosage</label>
                        <input type="text" name="dosage" required class="w-full border rounded-lg p-2" placeholder="e.g., 100mg">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Frequency</label>
                        <select name="frequency" class="w-full border rounded-lg p-2">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="as_needed">As Needed</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Reminder Time</label>
                        <input type="time" name="time" class="w-full border rounded-lg p-2" value="08:00">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                        <input type="date" name="startDate" required class="w-full border rounded-lg p-2">
                    </div>
                    
                    <button type="submit" class="w-full bg-purple-600 text-white py-2 rounded-lg font-semibold hover:bg-purple-700 transition">
                        Add Reminder
                    </button>
                </div>
            </form>
        </div>
        
        <div class="bg-white rounded-lg shadow-lg p-6 mt-8">
            <h2 class="text-xl font-bold mb-4">Current Reminders</h2>
            <div class="mb-4">
                <button onclick="testNotification()" class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700">
                    ðŸ§ª Test Notification
                </button>
                <span class="ml-2 text-sm text-gray-500">Click to see how notifications look</span>
            </div>
            <div id="remindersList" class="space-y-4">
                <div class="text-center text-gray-500 py-8">Loading reminders...</div>
            </div>
        </div>
    </div>

<script>
// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadReminders();
    document.querySelector('input[name="startDate"]').value = new Date().toISOString().split('T')[0];
    
    // Check for due reminders every 30 seconds
    setInterval(checkDueReminders, 30000);
    
    // Check immediately on page load
    setTimeout(checkDueReminders, 2000);
});

// Form submission
document.getElementById('reminderForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    
    const reminderData = {
        medication_name: formData.get('medication'),
        dosage: formData.get('dosage'),
        frequency: formData.get('frequency'),
        reminder_times: [formData.get('time')],
        start_date: formData.get('startDate'),
        ringtone: "default"
    };
    
    try {
        const response = await fetch('http://localhost:5000/medication/reminders', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(reminderData)
        });
        
        if (response.ok) {
            alert('Reminder added successfully!');
            e.target.reset();
            document.querySelector('input[name="startDate"]').value = new Date().toISOString().split('T')[0];
            loadReminders();
        } else {
            const error = await response.json();
            alert('Error: ' + error.detail);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

// Load reminders
async function loadReminders() {
    try {
        const response = await fetch('http://localhost:5000/medication/reminders');
        const reminders = await response.json();
        
        const container = document.getElementById('remindersList');
        
        if (reminders.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-8">No reminders yet. Add your first reminder above!</div>';
            return;
        }
        
        container.innerHTML = reminders.map(reminder => `
            <div class="border rounded-lg p-4 hover:bg-gray-50">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h4 class="font-semibold text-lg">${reminder.medication_name}</h4>
                        <p class="text-gray-600">${reminder.dosage} - ${reminder.frequency}</p>
                        <div class="mt-2 text-sm text-gray-500">
                            Times: ${reminder.reminder_times.join(', ')}
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="deleteReminder('${reminder.id}')" class="text-red-600 hover:text-red-700">
                            Ã—
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error loading reminders:', error);
        document.getElementById('remindersList').innerHTML = '<div class="text-center text-red-500">Error loading reminders</div>';
    }
}

// Delete reminder
async function deleteReminder(reminderId) {
    if (!confirm('Are you sure you want to delete this reminder?')) return;
    
    try {
        const response = await fetch(`http://localhost:5000/medication/reminders/${reminderId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('Reminder deleted successfully!');
            loadReminders();
        } else {
            const error = await response.json();
            alert('Error: ' + error.detail);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Check for due reminders and show notifications
async function checkDueReminders() {
    try {
        const response = await fetch('http://localhost:5000/medication/schedule/today');
        const schedule = await response.json();
        
        const now = new Date();
        const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
        
        schedule.reminders.forEach(reminder => {
            reminder.reminder_times.forEach(time => {
                // Check if reminder time is within 1 minute of current time
                const reminderTime = time.split(':').slice(0, 2).join(':');
                const reminderDate = new Date();
                reminderDate.setHours(parseInt(time.split(':')[0]));
                reminderDate.setMinutes(parseInt(time.split(':')[1]));
                
                const timeDiff = Math.abs(now - reminderDate) / 1000 / 60; // Difference in minutes
                
                if (timeDiff <= 1 && timeDiff >= 0) {
                    showMedicationNotification(reminder);
                }
            });
        });
    } catch (error) {
        console.error('Error checking due reminders:', error);
    }
}

// Show medication notification
function showMedicationNotification(reminder) {
    // Create notification modal
    const notificationModal = document.createElement('div');
    notificationModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    notificationModal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 border-4 border-orange-500">
            <div class="flex items-center mb-4">
                <div class="bg-orange-100 rounded-full p-3 mr-3">
                    <svg class="w-8 h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-gray-900">Medication Reminder!</h3>
                    <p class="text-sm text-gray-600">It's time to take your medication</p>
                </div>
            </div>
            
            <div class="bg-orange-50 rounded-lg p-4 mb-4">
                <h4 class="font-semibold text-lg">${reminder.medication_name}</h4>
                <p class="text-gray-600">${reminder.dosage}</p>
                <p class="text-sm text-gray-500">Time: ${reminder.reminder_times.join(', ')}</p>
                ${reminder.notes ? `<p class="text-sm text-gray-500 mt-1">${reminder.notes}</p>` : ''}
            </div>
            
            <div class="flex space-x-2">
                <button onclick="confirmTakenFromNotification('${reminder.id}'); this.closest('.fixed').remove();" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                    âœ“ Taken
                </button>
                <button onclick="skipDoseFromNotification('${reminder.id}'); this.closest('.fixed').remove();" class="flex-1 bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700">
                    Skip
                </button>
                <button onclick="this.closest('.fixed').remove();" class="flex-1 bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700">
                    Later
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(notificationModal);
    
    // Auto-remove after 2 minutes if no action
    setTimeout(() => {
        if (document.body.contains(notificationModal)) {
            notificationModal.remove();
        }
    }, 120000);
    
    // Play notification sound (if available)
    playNotificationSound();
}

// Confirm taken from notification
async function confirmTakenFromNotification(reminderId) {
    try {
        const response = await fetch(`http://localhost:5000/medication/reminders/${reminderId}/log?taken`, {
            method: 'POST'
        });
        
        if (response.ok) {
            loadReminders();
        }
    } catch (error) {
        console.error('Error logging medication:', error);
    }
}

// Skip dose from notification
async function skipDoseFromNotification(reminderId) {
    try {
        const response = await fetch(`http://localhost:5000/medication/reminders/${reminderId}/log?skipped`, {
            method: 'POST'
        });
        
        if (response.ok) {
            loadReminders();
        }
    } catch (error) {
        console.error('Error logging medication:', error);
    }
}

// Play notification sound (simulated)
function playNotificationSound() {
    // Create a simple beep sound using Web Audio API
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800; // 800Hz beep
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
    } catch (error) {
        console.log('Audio not supported');
    }
}

// Test notification function
function testNotification() {
    const testReminder = {
        id: 'test-123',
        medication_name: 'Test Medication',
        dosage: '100mg',
        reminder_times: ['Current Time'],
        notes: 'This is a test notification'
    };
    showMedicationNotification(testReminder);
}
</script>
</body>
</html>
