<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medication Reminders - AROGYA Healthcare</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <!-- Authentication Header -->
    <div class="bg-white shadow">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-blue-600">AROGYA Healthcare</h1>
                <div id="user-info" class="flex items-center space-x-4">
                    <span id="user-name" class="text-gray-700"></span>
                    <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Medication Reminders</h1>
                <p class="text-gray-600">Never miss your medications with smart reminders</p>
            </div>
            <div id="auth-status" class="text-sm text-gray-500"></div>
        </div>
        
        <div class="bg-white rounded-lg shadow-lg p-6 mt-8">
            <h2 class="text-xl font-bold mb-4">Add New Reminder</h2>
            <form id="reminderForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Medication Name</label>
                        <input type="text" name="medication" required class="w-full border rounded-lg p-2" placeholder="e.g., Aspirin">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Dosage</label>
                        <input type="text" name="dosage" required class="w-full border rounded-lg p-2" placeholder="e.g., 100mg">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Frequency</label>
                        <select name="frequency" class="w-full border rounded-lg p-2">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="as_needed">As Needed</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Reminder Time</label>
                        <input type="time" name="time" class="w-full border rounded-lg p-2" value="08:00">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                        <input type="date" name="startDate" required class="w-full border rounded-lg p-2">
                    </div>
                    
                    <button type="submit" class="w-full bg-purple-600 text-white py-2 rounded-lg font-semibold hover:bg-purple-700 transition">
                        Add Reminder
                    </button>
                </div>
            </form>
        </div>
        
        <div class="bg-white rounded-lg shadow-lg p-6 mt-8">
            <h2 class="text-xl font-bold mb-4">Current Reminders</h2>
            <div class="mb-4">
                <button onclick="testNotification()" class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700">
                    ðŸ§ª Test Notification
                </button>
                <span class="ml-2 text-sm text-gray-500">Click to see how notifications look</span>
            </div>
            <div id="remindersList" class="space-y-4">
                <div class="text-center text-gray-500 py-8">Loading reminders...</div>
            </div>
        </div>
    </div>

<script>
// Set default date
document.addEventListener('DOMContentLoaded', function() {
    document.querySelector('input[name="startDate"]').value = new Date().toISOString().split('T')[0];
});
    
    // Check immediately on page load
    setTimeout(checkDueReminders, 2000);

// Form submission
document.getElementById('reminderForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    
    const reminderData = {
        medication_name: formData.get('medication'),
        dosage: formData.get('dosage'),
        frequency: formData.get('frequency'),
        reminder_times: [formData.get('time')],
        start_date: formData.get('startDate'),
        ringtone: "default"
    };
    
    try {
        const response = await fetch('http://localhost:5000/medication/reminders', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(reminderData)
        });
        
        if (response.ok) {
            alert('Reminder added successfully!');
            e.target.reset();
            document.querySelector('input[name="startDate"]').value = new Date().toISOString().split('T')[0];
            loadReminders();
        } else {
            const error = await response.json();
            alert('Error: ' + error.detail);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

// Load reminders
async function loadReminders() {
    try {
        const response = await fetch('http://localhost:5000/medication/reminders');
        const reminders = await response.json();
        
        const container = document.getElementById('remindersList');
        
        if (reminders.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-8">No reminders yet. Add your first reminder above!</div>';
            return;
        }
        
        container.innerHTML = reminders.map(reminder => `
            <div class="border rounded-lg p-4 hover:bg-gray-50">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h4 class="font-semibold text-lg">${reminder.medication_name}</h4>
                        <p class="text-gray-600">${reminder.dosage} - ${reminder.frequency}</p>
                        <div class="mt-2 text-sm text-gray-500">
                            Times: ${reminder.reminder_times.join(', ')}
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="deleteReminder('${reminder.id}')" class="text-red-600 hover:text-red-700">
                            Ã—
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error loading reminders:', error);
        document.getElementById('remindersList').innerHTML = '<div class="text-center text-red-500">Error loading reminders</div>';
    }
}

// Delete reminder
async function deleteReminder(reminderId) {
    if (!confirm('Are you sure you want to delete this reminder?')) return;
    
    try {
        const response = await fetch(`http://localhost:5000/medication/reminders/${reminderId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('Reminder deleted successfully!');
            loadReminders();
        } else {
            const error = await response.json();
            alert('Error: ' + error.detail);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Check for due reminders and show notifications
async function checkDueReminders() {
    try {
        const response = await fetch('http://localhost:5000/medication/schedule/today');
        const schedule = await response.json();
        
        const now = new Date();
        const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
        
        schedule.reminders.forEach(reminder => {
            reminder.reminder_times.forEach(time => {
                // Check if reminder time is within 1 minute of current time
                const reminderTime = time.split(':').slice(0, 2).join(':');
                const reminderDate = new Date();
                reminderDate.setHours(parseInt(time.split(':')[0]));
                reminderDate.setMinutes(parseInt(time.split(':')[1]));
                
                const timeDiff = Math.abs(now - reminderDate) / 1000 / 60; // Difference in minutes
                
                if (timeDiff <= 1 && timeDiff >= 0) {
                    showMedicationNotification(reminder);
                }
            });
        });
    } catch (error) {
        console.error('Error checking due reminders:', error);
    }
}

// Show medication notification
function showMedicationNotification(reminder) {
    // Create notification modal
    const notificationModal = document.createElement('div');
    notificationModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    notificationModal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 border-4 border-orange-500">
            <div class="flex items-center mb-4">
                <div class="bg-orange-100 rounded-full p-3 mr-3">
                    <svg class="w-8 h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-gray-900">Medication Reminder!</h3>
                    <p class="text-sm text-gray-600">It's time to take your medication</p>
                </div>
            </div>
            
            <div class="bg-orange-50 rounded-lg p-4 mb-4">
                <h4 class="font-semibold text-lg">${reminder.medication_name}</h4>
                <p class="text-gray-600">${reminder.dosage}</p>
                <p class="text-sm text-gray-500">Time: ${reminder.reminder_times.join(', ')}</p>
                ${reminder.notes ? `<p class="text-sm text-gray-500 mt-1">${reminder.notes}</p>` : ''}
            </div>
            
            <div class="flex space-x-2">
                <button onclick="confirmTakenFromNotification('${reminder.id}'); this.closest('.fixed').remove();" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                    âœ“ Taken
                </button>
                <button onclick="skipDoseFromNotification('${reminder.id}'); this.closest('.fixed').remove();" class="flex-1 bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700">
                    Skip
                </button>
                <button onclick="snoozeReminder('${reminder.id}', '${reminder.medication_name}'); this.closest('.fixed').remove();" class="flex-1 bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700">
                    Later (5 min)
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(notificationModal);
    
    // Auto-remove after 2 minutes if no action
    setTimeout(() => {
        if (document.body.contains(notificationModal)) {
            notificationModal.remove();
        }
    }, 120000);
    
    // Play notification sound (if available)
    playNotificationSound();
}

// Confirm taken from notification
async function confirmTakenFromNotification(reminderId) {
    try {
        const response = await fetch(`http://localhost:5000/medication/reminders/${reminderId}/log?taken`, {
            method: 'POST'
        });
        
        if (response.ok) {
            loadReminders();
        }
    } catch (error) {
        console.error('Error logging medication:', error);
    }
}

// Skip dose from notification
async function skipDoseFromNotification(reminderId) {
    try {
        const response = await fetch(`http://localhost:5000/medication/reminders/${reminderId}/log?skipped`, {
            method: 'POST'
        });
        
        if (response.ok) {
            loadReminders();
        }
    } catch (error) {
        console.error('Error logging medication:', error);
    }
}

// Snooze reminder - show again after 5 minutes
function snoozeReminder(reminderId, medicationName) {
    console.log(`Snoozing reminder ${reminderId} for ${medicationName} for 5 minutes`);
    
    // Store snooze info
    const snoozeKey = `snooze_${reminderId}`;
    const snoozeData = {
        reminderId: reminderId,
        medicationName: medicationName,
        snoozeTime: new Date().toISOString(),
        nextNotificationTime: new Date(Date.now() + 5 * 60 * 1000).toISOString() // 5 minutes from now
    };
    localStorage.setItem(snoozeKey, JSON.stringify(snoozeData));
    
    // Show confirmation
    showSnoozeConfirmation(medicationName);
}

// Show snooze confirmation
function showSnoozeConfirmation(medicationName) {
    const confirmation = document.createElement('div');
    confirmation.className = 'fixed top-4 right-4 bg-blue-50 border border-blue-200 rounded-lg p-4 shadow-lg z-50';
    confirmation.innerHTML = `
        <div class="flex items-center">
            <svg class="h-5 w-5 text-blue-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
            </svg>
            <div>
                <p class="text-sm font-medium text-blue-800">Reminder Snoozed</p>
                <p class="text-sm text-blue-600">${medicationName} reminder will show again in 5 minutes</p>
            </div>
        </div>
    `;
    
    document.body.appendChild(confirmation);
    
    // Remove after 3 seconds
    setTimeout(() => {
        if (document.body.contains(confirmation)) {
            confirmation.remove();
        }
    }, 3000);
}

// Check for snoozed reminders
function checkSnoozedReminders() {
    const now = new Date();
    
    // Check all snoozed reminders
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('snooze_')) {
            try {
                const snoozeData = JSON.parse(localStorage.getItem(key));
                const nextNotificationTime = new Date(snoozeData.nextNotificationTime);
                
                // If it's time to show the notification again
                if (now >= nextNotificationTime) {
                    console.log(`Reshowing snoozed reminder: ${snoozeData.medicationName}`);
                    
                    // Create reminder object for notification
                    const reminder = {
                        id: snoozeData.reminderId,
                        medication_name: snoozeData.medicationName,
                        dosage: 'Snoozed Reminder',
                        reminder_times: ['Now'],
                        notes: 'This was snoozed and is now being shown again'
                    };
                    
                    // Show notification
                    showMedicationNotification(reminder);
                    
                    // Remove snooze data
                    localStorage.removeItem(key);
                }
            } catch (error) {
                console.error('Error checking snoozed reminder:', error);
                // Remove corrupted snooze data
                localStorage.removeItem(key);
            }
        }
    }
}

// Enhanced notification sound with better audio
function playNotificationSound() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Create a more attention-grabbing sound pattern
        const playBeep = (frequency, duration, delay = 0) => {
            setTimeout(() => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration/1000);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration/1000);
            }, delay);
        };
        
        // Play a pattern: high-low-high (like a phone ring)
        playBeep(1000, 200, 0);    // High beep
        playBeep(600, 200, 300);    // Low beep  
        playBeep(1000, 300, 600);   // High beep (longer)
        
        // Request notification permission if not granted
        if ("Notification" in window && Notification.permission === "default") {
            Notification.requestPermission();
        }
        
        // Also show browser notification if permitted
        if ("Notification" in window && Notification.permission === "granted") {
            new Notification("Medication Reminder", {
                body: "Time to take your medication!",
                icon: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23ef4444' viewBox='0 0 20 20'%3E%3Cpath fill-rule='evenodd' d='M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z' clip-rule='evenodd'/%3E%3C/svg%3E",
                tag: "medication-reminder"
            });
        }
        
    } catch (error) {
        console.log('Audio notification not supported:', error);
    }
}

// Authentication functions
function getAuthToken() {
    return localStorage.getItem('access_token');
}

function isAuthenticated() {
    return !!getAuthToken();
}

function logout() {
    // Call backend logout
    const token = getAuthToken();
    if (token) {
        fetch('http://localhost:5000/auth/logout', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        }).catch(error => console.log('Logout error:', error));
    }
    
    // Clear local storage
    localStorage.removeItem('access_token');
    localStorage.removeItem('refresh_token');
    localStorage.removeItem('user');
    
    // Redirect to login
    window.location.href = '/login';
}

function updateAuthUI() {
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    const userName = document.getElementById('user-name');
    const authStatus = document.getElementById('auth-status');
    
    if (isAuthenticated() && user.email) {
        userName.textContent = user.email || user.full_name || 'User';
        authStatus.textContent = 'Authenticated';
    } else {
        userName.textContent = 'Guest';
        authStatus.textContent = 'Not authenticated';
    }
}

// Check authentication on page load
document.addEventListener('DOMContentLoaded', function() {
    if (!isAuthenticated()) {
        // Redirect to login if not authenticated
        window.location.href = '/login';
        return;
    }
    
    // Update UI with user info
    updateAuthUI();
    
    // Set up logout button
    document.getElementById('logout-btn').addEventListener('click', logout);
    
    // Update all API calls to include auth token
    const originalFetch = window.fetch;
    window.fetch = function(url, options = {}) {
        const token = getAuthToken();
        if (token) {
            options.headers = {
                ...options.headers,
                'Authorization': `Bearer ${token}`
            };
        }
        return originalFetch(url, options);
    };
    
    // Load reminders (now with auth)
    loadReminders();
    
    // Check immediately for due reminders
    checkDueReminders();
    checkSnoozedReminders();
    
    // Start notification checking (every 30 seconds)
    setInterval(() => {
        checkDueReminders();
        checkSnoozedReminders();
    }, 30000);
    
    // Also check snoozed reminders more frequently (every 10 seconds)
    setInterval(checkSnoozedReminders, 10000);
    
    // Check exact timing every minute for precision
    setInterval(() => {
        checkExactTimeReminders();
    }, 60000);
});

// Check for exact time reminders (more precise)
function checkExactTimeReminders() {
    const now = new Date();
    const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
    
    console.log(`Checking exact time reminders at ${currentTime}`);
    
    // Get reminders from localStorage or API
    const reminders = JSON.parse(localStorage.getItem('reminders') || '[]');
    
    reminders.forEach(reminder => {
        if (reminder.status === 'active') {
            reminder.reminder_times.forEach(time => {
                const reminderTime = time.split(':').slice(0, 2).join(':'); // Get HH:MM format
                
                // Check if current time matches reminder time (within 1 minute window)
                if (reminderTime === currentTime) {
                    console.log(`Exact time match: ${reminder.medication_name} at ${currentTime}`);
                    
                    // Check if we already notified for this time today
                    const notificationKey = `notified_${reminder.id}_${new Date().toDateString()}_${reminderTime}`;
                    const alreadyNotified = localStorage.getItem(notificationKey);
                    
                    if (!alreadyNotified) {
                        console.log(`Showing exact time notification for ${reminder.medication_name}`);
                        showMedicationNotification(reminder);
                        
                        // Mark as notified for this time
                        localStorage.setItem(notificationKey, 'true');
                        
                        // Clear old notification marks (older than 2 hours)
                        clearOldNotificationMarks();
                    }
                }
            });
        }
    });
}

// Clear old notification marks to prevent memory buildup
function clearOldNotificationMarks() {
    const now = new Date();
    const twoHoursAgo = now.getTime() - (2 * 60 * 60 * 1000);
    
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('notified_')) {
            try {
                const parts = key.split('_');
                if (parts.length >= 4) {
                    const dateStr = parts[2]; // Extract date part
                    const timeStr = parts[3]; // Extract time part
                    const notificationTime = new Date(`${dateStr} ${timeStr}:00`);
                    
                    if (notificationTime.getTime() < twoHoursAgo) {
                        localStorage.removeItem(key);
                    }
                }
            } catch (error) {
                // Remove corrupted keys
                localStorage.removeItem(key);
            }
        }
    }
}

// Test notification function
function testNotification() {
    const testReminder = {
        id: 'test-123',
        medication_name: 'Test Medication',
        dosage: '100mg',
        reminder_times: ['Current Time'],
        notes: 'This is a test notification'
    };
    showMedicationNotification(testReminder);
}
</script>
</body>
</html>
